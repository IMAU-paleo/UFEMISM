clc
clear all
close all

foldername = '../results_20211216_001';

mesh = ReadMeshFromFile( [foldername '/restart_ANT_00001.nc']);

%% Read matrices from UFEMISM
mesh.M_ddx_a_b = read_CSR_from_NetCDF( [foldername '/M_ddx_a_b.nc']);
mesh.M_ddx_b_a = read_CSR_from_NetCDF( [foldername '/M_ddx_b_a.nc']);
mN_b           = read_CSR_from_NetCDF( [foldername '/mN_b.nc']);
mNddx_b        = read_CSR_from_NetCDF( [foldername '/mNddx_b.nc']);
M_a            = read_CSR_from_NetCDF( [foldername '/M_a.nc']);
BC_a           = read_CSR_from_NetCDF( [foldername '/BC_a.nc']);
M_a_BC         = read_CSR_from_NetCDF( [foldername '/M_a_BC.nc']);

%% Generate matrices in Matlab and check difference

%% mN_b
N_b = zeros( mesh.nTri,1);
amp = 1;
for ti = 1: mesh.nTri
  via = mesh.Tri( ti,1);
  vib = mesh.Tri( ti,2);
  vic = mesh.Tri( ti,3);
  x   = (mesh.V( via,1) + mesh.V( vib,1) + mesh.V( vic,1)) / 3;
  y   = (mesh.V( via,2) + mesh.V( vib,2) + mesh.V( vic,2)) / 3;
  xp  = (x - mesh.xmin) / (mesh.xmax - mesh.xmin);
  yp  = (y - mesh.ymin) / (mesh.ymax - mesh.ymin);
  N_b( ti) = 1 + exp(amp * sin( 2 * pi * xp) * sin( 2 * pi * yp));
end
mN_bp = sparse(diag( N_b,0));

dmN_b = full( mN_b) ./ full( mN_bp);
disp(['mN_b: [' num2str(min(dmN_b(:))) ' - ' num2str(max(dmN_b(:))) ']'])

%% mNddx_b
mNddx_bp = mN_b * mesh.M_ddx_a_b;

dmNddx_b = full( mNddx_b) ./ full( mNddx_bp);
disp(['mNddx_b: [' num2str(min(dmNddx_b(:))) ' - ' num2str(max(dmNddx_b(:))) ']'])

%% M_a
M_ap = mesh.M_ddx_b_a * mNddx_bp;

dM_a = full( M_a) ./ full( M_ap);
disp(['mNddx_b: [' num2str(min(dM_a(:))) ' - ' num2str(max(dM_a(:))) ']'])